<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project: build-O2</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../o2_logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d7/d55/md__2home_2runner_2work_2AliceO2_2AliceO2_2GPU_2documentation_2build-O2.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">build-O2</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This ticket will serve as documentation how to enable which GPU features and collect related issues.</p>
<p>So far, the following features exist:</p><ul>
<li>GPU Tracking with CUDA</li>
<li>GPU Tracking with HIP</li>
<li>GPU Tracking with OpenCL (&gt;= 2.1)</li>
<li>OpenGL visualization of the tracking</li>
<li>ITS GPU tracking</li>
</ul>
<p>GPU support should be detected and enabled automatically. If you just want to reproduce the GPU build locally without running it, it might be easiest to use the GPU CI container (see below). The provisioning script of the container also demonstrates which patches need to be applied such that everything works correctly.</p>
<p>In a nutshell, all is steered via CMake variables, and the <code>ALIBUILD_O2_FORCE_GPU...</code> environment variables exist to steer what <a href="https://github.com/alisw/alidist/blob/master/o2.sh">alidist/o2.sh</a> puts as CMake defaults. We try to run the same CMake GPU detection as in O2 (<a href="https://github.com/AliceO2Group/AliceO2/blob/dev/dependencies/FindO2GPU.cmake">FindO2GPU.cmake</a>) during the aliBuild <code>prefer_system_check</code> (<a href="https://github.com/alisw/alidist/blob/master/gpu-system.sh">gpu-system.sh</a>), such that all GPU features / versions / architectures can become part of the <code>gpu-system</code> version, which avoid inconsistencies between different packages we build.</p>
<p>All is steered via environment variables, which will go into the version and thus the hash:</p><ul>
<li><code>ALIBUILD_O2_FORCE_GPU=...</code> sets the mode</li>
<li><code>ALIBUILD_O2_FORCE_GPU_CUDA=1</code> can force-enable (<code>=1</code>) or disable (<code>=0</code>) backends, even if they were not detected. Same for <code>..._HIP</code> and <code>..._OPENCL</code>.</li>
<li><code>ALIBUILD_O2_FORCE_GPU_CUDA_ARCH=...</code> can override the architecture to cross-compile, e.g. <code>ALIBUILD_O2_FORCE_GPU_CUDA_ARCH="86;89"</code>. Same for <code>..._HIP_ARCH</code>.</li>
</ul>
<p>Modes for <code>ALIBUILD_O2_FORCE_GPU</code></p><ul>
<li><code>force</code> / <code>1</code> / <code>ci</code>: Force that all backends / features are detected, fail if not. GPU architectures are set to the default ones if not specified by environment variables. CI is currently identical to force, but should allow special behavior when running in the CI.</li>
<li><code>auto</code>: check for supported system-cmake version, fail if not found. Auto-detect GPU backends / features and architectures. Selected features can be force-enabled on top via env variable. But not selectively disabled. (But one can use the manual mode below.)</li>
<li><code>onthefly</code>: Don't detect GPUs at alidist levels. gPUs disabled in ONNX. GPUs auto-detcted in O2 CMake during build as before, but this means the O2 build hash does not depend on GPU features, so we also have the same problems as before. This is just a fallback, to allow users to build with GPUs if they don't have a compatible system CMake.</li>
<li><code>fullauto</code>: Detect supported system-cmake. If found, behave as Auto. If not found behave as OnTheFly.</li>
<li><code>disabled</code>: Disable all GPU builds. No extra time during aliBuild command.</li>
<li><code>manual</code>: all GPU builds disabled by default, to be enabled manually via env variable. No extra time during aliBuild command.</li>
</ul>
<p><em>Additional reasoning for this approach</em> Advantages:</p><ul>
<li>O2 hash and ONNX hash depend on available GPU backends, detected features (like tensorrt for ML) and on the detected GPU architectures and librar versions. I.e. when you plug in a new GPU or update the CUDA version, the O2 hash will change and this will trigger a rebuild. Otherwise, the build could just fail due to stale settings in CMakeCache.</li>
<li>We can have binary tarballs depending on the enabled backends.</li>
<li>O2 and ONNX are always in sync.</li>
<li>Same detection during aliBuild as in O2 CMake.</li>
<li>One can see enabled GPU features / versions / architectures in the version string of <code>gpu-system</code>.</li>
</ul>
<p>Disadvantages:</p><ul>
<li>Need system <code>CMake</code> &gt;= <code>3.26</code> for the detsction at aliBuild level.</li>
<li><code>FindO2GPU.cmake</code> is duplicated in O2 and alidist and must be kept in sync. But at least this is checked and gives an error otherwise.</li>
<li>Running cmake during the system check takes around 5 sec for every aliBuild command involving O2 or ONNX.</li>
</ul>
<p><em>GPU Tracking with CUDA</em></p><ul>
<li>The CMake option <code>-DENABLE_CUDA=ON/OFF/AUTO</code> steers whether CUDA is forced enabled / unconditionally disabled / auto-detected.</li>
<li>The CMake option <code>-DCUDA_COMPUTETARGET=...</code> fixes a GPU target, e.g. 61 for PASCAL or 75 for Turing (if unset, it compiles for the lowest supported architecture)</li>
<li>CUDA is detected via the CMake language feature, so essentially nvcc must be in the Path.</li>
<li>We require CUDA version &gt;= 12.8</li>
<li>CMake will report "Building GPUTracking with CUDA support" when enabled.</li>
</ul>
<p><em>GPU Tracking with HIP</em></p><ul>
<li>HIP must be installed, and CMake must be able to detect HIP via find_package(hip) and enable language(hip).</li>
<li>For the minimum ROCm / HIP version, please check <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/dependencies/FindO2GPU.cmake#L287">FindO2GPU.cmake</a>.</li>
<li>The CMake option <code>-DHIP_AMDGPUTARGET=...</code> / env variable <code>ALIBUILD_O2_FORCE_GPU_HIP_ARCH=...</code> forces a GPU target, e.g. gfx906 for MI50 (if unset, it auto-detects the GPU).</li>
<li>CMake will report "Building GPUTracking with HIP support" when enabled.</li>
<li>It may be that some patches must be applied to ROCm after the installation. You find the details in the provisioning script of the GPU CI container below.</li>
</ul>
<p><em>GPU Tracking with OpenCL (Needs Clang &gt;= 18 for compilation)</em></p><ul>
<li>Needs OpenCL library with version &gt;= 2.1, detectable via CMake find_package(OpenCL).</li>
<li>Needs the SPIR-V LLVM translator together with LLVM to create the SPIR-V binaries, also detectable via CMake.</li>
</ul>
<p><em>OpenGL visualization of TPC tracking</em></p><ul>
<li>Needs the following libraries (all detectable via CMake find_package): libOpenGL, libGLEW or libGLFW (default), libGLU.</li>
<li>OpenGL must be at least version 4.5, but this is not detectable at CMake time. If the supported OpenGL version is below, the display is not/partially built, and not available at runtime. (Whether it is not or partially built depends on whether the maximum OpenGL version supported by GLEW or that of the system runtime in insufficient.)</li>
<li>Note: If <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> does not detect the system GLEW library, <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> will install its own very outdated GLEW library, which will be insufficient for the display. Since the <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> include path will come first in the order, this will prevent the display from being built.</li>
<li>CMake will report "Building GPU Event Display" when enabled.</li>
</ul>
<p><em>Vulkan visualization</em></p><ul>
<li>similar to OpenCL visualization, but with Vulkan.</li>
</ul>
<p><em>ITS GPU Tracking</em></p><ul>
<li>So far supports only CUDA and HIP, support for OpenCL might come.</li>
<li>The build is enabled when the "GPU Tracking with CUDA" (as explained above) detects CUDA, same for HIP.</li>
<li>CMake will report "Building ITS CUDA tracker" when enabled, same for HIP.</li>
</ul>
<p><em>Using the GPU CI container</em></p><ul>
<li>Setting up everything locally might be somewhat time-consuming, instead you can use the GPU CI cdocker container.</li>
<li>The docker images is <code>alisw/slc9-gpu-builder</code>.</li>
<li>The container exports the <code>ALIBUILD_O2_FORCE_GPU=1</code> env variable, which force-enables all GPU builds.</li>
<li>Note that it might not be possible out-of-the-box to run the GPU version from within the container. In case of HIP it should work when you forwards the necessary GPU devices in the container. For CUDA however, you would either need to (in addition to device forwarding) match the system CUDA driver and toolkit installation to the files present in the container, or you need to use the CUDA docker runtime, which is currently not installed in the container.</li>
<li>There are currently some patches needed to install all the GPU backends in a proper way and together. Please refer to the container provisioning script <a href="https://github.com/alisw/docks/blob/master/slc9-gpu-builder/provision.sh">provision.sh</a>. If you want to reproduce the installation locally, it is recommended to follow the steps from the script.</li>
</ul>
<p><em><a class="el" href="../../d1/d4a/structSummary.html">Summary</a></em></p>
<p>If you want to enforce the GPU builds on a system without GPU, please export the following environment variables:</p><ul>
<li><code>ALIBUILD_O2_FORCE_GPU_CUDA=ON</code></li>
<li><code>ALIBUILD_O2_FORCE_GPU_HIP=ON</code></li>
<li><code>ALIBUILD_O2_FORCE_GPU_OPENCL=ON</code></li>
<li><code>ALIBUILD_O2_FORCE_GPU_CUDA_ARCH=default</code></li>
<li><code>ALIBUILD_O2_FORCE_GPU_HIP_ARCH=default</code> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Oct 31 2025 12:28:23 for Project by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
