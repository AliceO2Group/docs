<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project: Average Distortion Correction</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../o2_logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('dc/d0f/refTPCcalibrationAverageDistortionCorrection.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Average Distortion Correction</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>TPC average distortion correction</h1>
<p>The average correction for TPC space charge distortions is based on residuals of TPC clusters with respect to global ITS-TPC-TRD-TOF tracks. Multiple DPL devices at different stages are involved as can be seen in the sketch below:</p>
<p><img src="https://user-images.githubusercontent.com/26281793/195542425-136852a3-f9e9-4c85-9490-f2cfb262686c.png" alt="TPC-SCD-scheme" class="inline"/></p>
<p>On each EPN the residuals of the TPC clusters wrt global tracks are collected and sent for each <a class="el" href="../../d5/d14/structTF.html">TF</a> to the aggregator. Here the residuals are put into voxels and for each voxel some statistics are collected (number of entries and center of gravity in <a class="el" href="../../d3/d90/structXYZ.html">XYZ</a> for all residuals). The aggregator produces one file per calibration slot and this file will eventually shipped to EOS.</p>
<p>The workflow on the EPNs can be configured to sent in addition to the residuals also the track data by settings </p><div class="fragment"><div class="line">CALIB_TPC_SCDCALIB_SENDTRKDATA=1</div>
</div><!-- fragment --><p> Currently this is the default and can be disabled by putting <code>CALIB_TPC_SCDCALIB_SENDTRKDATA=0</code> as extra ENV variable.</p>
<p>The workflow running on the aggregator is at the moment causing backpressure on the calibration nodes. In order to mitigate this the <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> compression can be disabled which should make the processing much faster. This is added as option to the <code>o2-calibration-residual-aggregator</code> workflow.</p>
<div class="fragment"><div class="line">ARGS_EXTRA_PROCESS_o2_calibration_residual_aggregator=&quot;--compression 0&quot;</div>
</div><!-- fragment --><p> Note, that currently writing to EOS is disabled. Once the workflow is validated it should be enabled in <code>aggregator-workflow.sh</code>: <a href="https://github.com/AliceO2Group/AliceO2/blob/cb98b7e5f036024dfce73abf2b6bdb3ad432d1b4/prodtests/full-system-test/aggregator-workflow.sh#L177-L181">https://github.com/AliceO2Group/AliceO2/blob/cb98b7e5f036024dfce73abf2b6bdb3ad432d1b4/prodtests/full-system-test/aggregator-workflow.sh#L177-L181</a></p>
<h2>Running the calibration offline from <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> file input</h2>
<p>For running the track interpolation offline which creates the unbinned residuals one needs to have the following inputs in the local directory as <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> files:</p>
<ul>
<li>clusters, tracks, track matches for all barrell detectors ITS, TPC, TRD and TOF</li>
<li>the <a class="el" href="../../d5/d14/structTF.html">TF</a> ID information typically stored in o2_tfidinfo.root</li>
</ul>
<p>Now, one can rerun the interpolation workflow piping its output directly into the residual aggregator which creates the o2tpc_residuals*.root files with the specified output (residuals binned/unbinned, track information):</p>
<div class="fragment"><div class="line">o2-tpc-scdcalib-interpolation-workflow -b --send-track-data --disable-mc --hbfutils-config o2_tfidinfo.root | \</div>
<div class="line">o2-calibration-residual-aggregator -b --enable-track-input  --output-type unbinnedResid,binnedResid,trackParams --output-dir $PWD --disable-root-input</div>
</div><!-- fragment --><p>Since the workflow loads also the TPC native clusters which are rather large, you will most likely need to increase the SHM size via adding <code>--shm-segment-size 32000000000</code> to both workflows.</p>
<h4>Track selection</h4>
<p>Track selections are applied at the interpolation stage. This can be steered via configurable parameters. For example add</p>
<div class="fragment"><div class="line">--configKeyValues &quot;scdcalib.maxTracksPerCalibSlot=-1;scdcalib.minTPCNCls=70&quot;</div>
</div><!-- fragment --><p> in order to process all global tracks which are available per <a class="el" href="../../d5/d14/structTF.html">TF</a> and have at least 70 TPC clusters. For all options please have a look at <code><a class="el" href="../../db/dca/SpacePointsCalibConfParam_8h.html">Detectors/TPC/calibration/SpacePoints/include/SpacePoints/SpacePointsCalibConfParam.h</a></code></p>
<h3>Creating the distortion map from unbinned residuals</h3>
<p>When the unbinned residuals are available it is possible to create the distortion map directly from those and on-the-fly change the track selection, e.g. taking into account only ITS-TPC-TRD tracks or only tracks with a very high quality. Use the <code>Detectors/TPC/calibration/SpacePoints/macro/staticMapCreator.C</code> macro in compiled mode. You will need to specify the input file (single <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> file or list of files) and the run number. Optionally you can specify the output file name or the track type to be used (default is ALL which are available as input, use e.g. "ITS-TPC-TRD" for only this type).</p>
<p>The track selection is steered via configurable param. Before running the macro it's best to create a configuration file which can then be adapted to ones needs: </p><div class="fragment"><div class="line">const o2::tpc::SpacePointsCalibConfParam&amp; params = o2::tpc::SpacePointsCalibConfParam::Instance();</div>
<div class="line">params.writeINI(&quot;scdconfig.ini&quot;, &quot;scdcalib&quot;); // to write default parameters to a file</div>
</div><!-- fragment --><p> For example to request only tracks with 5 ITS clusters, 2 TRD tracklets and a DCA &lt; 10 cm set </p><div class="fragment"><div class="line">minITSNCls=5</div>
<div class="line">minTRDNTrklts=2</div>
<div class="line">writeBinnedResiduals=true</div>
<div class="line">useTrackData=true</div>
<div class="line">cutOnDCA=true</div>
<div class="line">maxDCA=10</div>
</div><!-- fragment --><p> It is also possible to select only TFs from a specific time range. The time range needs to be provided in ms. The epoch time in seconds for a given date can be determined e.g. via <code>date -d "Nov 22 2022 16:00" +s</code>. Don't forget to multiply by 1000 to get ms. </p><div class="fragment"><div class="line">timeFilter=true</div>
<div class="line">startTimeMS=1666669765254</div>
<div class="line">endTimeMS=1666670365241</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d0/d2f/refDetectors.html">Module &#39;Detectors&#39;</a></li><li class="navelem"><a class="el" href="../../d5/d4d/refDetectorsTPC.html">TPC</a></li><li class="navelem"><a class="el" href="../../d7/d91/refTPCcalibration.html">TPC Calibration</a></li>
    <li class="footer">Generated on Sat Feb 21 2026 17:59:16 for Project by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
