<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project: full-system-test-as-stress-test</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../o2_logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d5/d4f/md__2home_2runner_2work_2AliceO2_2AliceO2_2prodtests_2full-system-test_2documentation_2full-system-test-as-stress-test.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">full-system-test-as-stress-test</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is a quick summary how to run the full system test (FST) as stress test on the EPN. (For the full FST documentation, see <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/prodtests/full-system-test/documentation/full-system-test-setup.md">https://github.com/AliceO2Group/AliceO2/blob/dev/prodtests/full-system-test/documentation/full-system-test-setup.md</a> and <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/prodtests/full-system-test/documentation/full-system-test.md">https://github.com/AliceO2Group/AliceO2/blob/dev/prodtests/full-system-test/documentation/full-system-test.md</a>)</p>
<h1>Preparing the data set</h1>
<ul>
<li>I usually try to keep an up-to-date data set that can be used in <code>/home/drohr/alitest/tmp-fst*</code>. The folder with the highest number is the latest dataset. However, data formats are still evolving, and it requires rerunning the simulation regularly. I.e. please try my latest data set, if it doesn't work, please generate a new one as described below.</li>
<li>Short overview how to generate a FST Pb-Pb 128 orbit data set:<ul>
<li>The O2 binaries installed on the EPN via RPMs use the <code>o2-dataflow</code> defaults and cannot run the simulation, and also they lack readout. Thus you need to build <code>O2PDPSuite</code> and <code>Readout</code> (the version matching the O2PDPSuite RPM you want to use for running the test) yourself with <code>alibuild</code> on an EPN: <code>aliBuild --defaults <a class="el" href="../../d4/d7c/namespaceo2.html" title="a couple of static helper functions to create timestamp values for CCDB queries or override obsolete ...">o2</a> build O2PDPSuite Readout --jobs 32 --debug</code>. The flag <code>--jobs</code> configures the number of parallel jobs and can be changed.</li>
<li>Enter the O2PDPSuite environment either vie <code>alienv enter O2PDPSuite/latest Readout/latest</code>.</li>
<li>Go to an empty directory.</li>
<li>Run the FST simulation via: <code>NEvents=650 NEventsQED=10000 SHMSIZE=128000000000 TPCTRACKERSCRATCHMEMORY=40000000000 SPLITTRDDIGI=0 GENERATE_ITSMFT_DICTIONARIES=1 $O2_ROOT/prodtests/full_system_test.sh</code></li>
<li>Material budget table (e.g. from here <a href="https://alice.its.cern.ch/jira/browse/O2-2288">https://alice.its.cern.ch/jira/browse/O2-2288</a>) now comes from CCDB, no need any more to pull it manually.</li>
<li>Create a timeframe file from the raw files: <code>$O2_ROOT/prodtests/full-system-test/convert-raw-to-tf-file.sh</code>.</li>
<li>Prepare the ramdisk folder: <code>mv raw/timeframe raw/timeframe-org; mkdir raw/timeframe-tmpfs; ln -s timeframe-tmpfs raw/timeframe</code></li>
</ul>
</li>
</ul>
<h1>Running the full system test</h1>
<ul>
<li>Enter the environment! On an EPN do <code>module load O2PDPSuite</code> (this will load the latest O2 software installed on that EPN).</li>
<li>Go into the folder with the data set (you might need to create one, see above).</li>
<li>Prepare the ramdisk with the data: <code>sudo mount -t tmpfs tmpfs raw/timeframe-tmpfs; sudo cp raw/timeframe-org/* raw/timeframe</code><ul>
<li>(NOTE that the ramdisk might already be present from previous tests, or in a different folder. Check the mounted tmpfs filesystems (<code>mount | grep tmpfs</code>), and don't mount multiple of them since memory is critical!)</li>
<li>If you do not have root permissions and cannot create a ramdisk, the test will also work without. In that case you should decrease the publishing rate below to <code>TFDELAY=5</code>.</li>
</ul>
</li>
<li>Make sure disk caches are cleared: as <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> do: <code>echo 1 &gt; /proc/sys/vm/drop_caches</code></li>
<li>In order to run the <a class="el" href="../../db/dd3/structFull.html">Full</a> System Test, the workflow must be able to access the CCDB. Normally, if you run as user, you must make sure to have an alien token present. On the EPN, one can use the EPN-internal CCDB server instead, which does not require alien access. If you use the <code>start-tmux.sh</code>, the env variables are set automatically to access the EPN-internal CCDB server.</li>
<li>Start the FST with 2 NUMA domains: <code>TFDELAY=2.5 NTIMEFRAMES=1000000 $O2_ROOT/prodtests/full-system-test/start_tmux.sh dd</code></li>
</ul>
<p>This will start a tmux session with 3 shells, the upper 2 shells are the 2 DPL workflows, one per NUMA domain, for the processing. The lower shell is the input with DataDistribution's StfBuilder. Leave it running and check that the StfBuilder doesn't complain that its buffer is full. Then the EPN can sustain the rate.</p>
<h1><b>NOTE</b></h1>
<ul>
<li>Attached to this ticket is a screenshot of how the console should look like:<ul>
<li>The DD console (on the bottom) should not show warnings about full buffers.</li>
<li>The other 2 consoles (1 per NUMA domain) should show the processing times per <a class="el" href="../../d5/d14/structTF.html">TF</a> for the GPU reconstruction: <div class="fragment"><div class="line">[2974450:gpu-reconstruction_t3]: [10:50:38][INFO] GPU Reoncstruction time for this TF 26.77 s (cpu), 17.8823 s (wall)</div>
</div><!-- fragment --> This should be 17 to 18 seconds, and you should see it for all 4 GPUs on both NUMA domains (<code>reconstruction_t0</code> to <code>reconstruction_t3</code>) </li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Oct 31 2025 12:28:23 for Project by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
