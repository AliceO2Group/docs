<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project: Full system test configuration and scripts</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../o2_logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d3/df1/refprodtestsfull-system-test.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Full system test configuration and scripts</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="el" href="../../db/dd3/structFull.html">Full</a> system test overview and quickstart guide</h2>
<p>The full system test consists of 2 parts (detailed below):</p><ul>
<li>The time frame generation part, which runs the simulation, embedding (if needed), digitization, raw conversion, and other misc tasks.</li>
<li><a class="el" href="../../d2/d88/classA.html">A</a> DPL workflow, which can run the synchronous and the asynchronous reconstruction.</li>
</ul>
<p>The relevant scripts are <code>/prodtests/full_system_test.sh</code> and all scripts in <code>/prodtests/full-system-test</code>. Note that by default the <code>full_system_test.sh</code> script will do both, run the generation and then the sysc and the async workflow. This is only a quickstart guide, for more information see <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/prodtests/full-system-test/documentation/full-system-test-setup.md">https://github.com/AliceO2Group/AliceO2/blob/dev/prodtests/full-system-test/documentation/full-system-test-setup.md</a>.</p>
<p>In order to run the full system test, you need to run in the O2sim environment (<code>alienv enter O2sim/latest</code>): </p><div class="fragment"><div class="line">NEvents=[N] NEventsQED=[NQ] SHMSIZE=[S] TPCTRACKERSCRATCHMEMORY=[ST] $O2_ROOT/prodtests/full_system_test.sh</div>
</div><!-- fragment --><p><a class="el" href="../../db/dd7/structParameters.html">Parameters</a> are set via environment variables. The 2 most important and mandatory parameters are <code>NEvents</code> and <code>NEventsQED</code>, which define how many collisions are in the timeframe, and how many collisions are simulated for the QED background. For simulating larger datasets, some memory sizes must be increased over the default, most importantly <code>SHMSIZE</code> and <code>TPCTRACKERSCRATCHMEMORY</code>. More options are available and documented in the script itself.</p>
<p>For a quick run of a timeframe with 5 events (depending on yous system it should take 3 to 0 minutes), run </p><div class="fragment"><div class="line">NEvents=5 NEventsQED=100 $O2_ROOT/prodtests/full_system_test.sh</div>
</div><!-- fragment --><p>For a simulation of a full 128 orbit time frame, run </p><div class="fragment"><div class="line">NEvents=650 NEventsQED=30000 SHMSIZE=128000000000 TPCTRACKERSCRATCHMEMORY=30000000000 $O2_ROOT/prodtests/full_system_test.sh</div>
</div><!-- fragment --><p> As of 2024, we are using 32 orbit time frames. Fo doing so, please set: </p><div class="fragment"><div class="line">NEVENTS=200 NHBPERTF=32</div>
</div><!-- fragment --><p> To simulate collisions with an embedded signal one can set 'D0_EMBEDDING=1' while also supplying a config file with the desired settings using 'FST_EMBEDDING_CONFIG'. For an example configuration see '/prodtests/full-system-test/pythia8.cfg' and to generate a specific configuration one can use '${O2DPG_ROOT}/MC/config/common/pythia8/utils/mkpy8cfg.py'. Additional examples can be found in '/run/SimExamples/' </p><div class="fragment"><div class="line">DO_EMBEDDING=1 NEvents=5 NEventsQED=100 $O2_ROOT/prodtests/full_system_test.sh</div>
</div><!-- fragment --><h2><a class="el" href="../../db/dd3/structFull.html">Full</a> system test time frame generation part</h2>
<p>The generation part (in <code>prodtests/full_system_test.sh</code> runs the following steps:</p><ul>
<li>Simulate the QED collisions</li>
<li>Simulate the collisions</li>
<li>Simulate a signal to embed (optional)</li>
<li>Digitize all data, by default split between in 2 phases for TRD and non-TRD to reduce the memory footprint (configured via <code>$SPLITTRDDIGI</code>).</li>
<li>Run TRD trap simulation</li>
<li>Optionally create optimized dictionaries for ITS and MFT</li>
<li>Run digits 2 raw conversion.</li>
<li>By default, afterwards it will also run the sync and async DPL workflows (configured via <code>$DISABLE_PROCESSING</code>).</li>
</ul>
<p>The <code>prodtests/full_system_test.sh</code> uses <code>Utilities/Tools/jobutils.sh</code> for running the jobs, which creates a log file for each step, and which will automatically skip steps that have already succeeded if the test is rerun in the current folder. I.e. if you break the FST or it failed at some point, you can rerun the same command line and it will continue after the last successful step. See <code>Utilities/Tools/jobutils.sh</code> for details.</p>
<p>Note that by default, the generation produces raw files, which can be consumed by the <code>raw-file-reader-workflow</code> and by <code>o2-readout-exe</code>. The files can be converted into timeframes files readable by the StfBuilder as described in <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/prodtests/full-system-test/documentation/full-system-test-setup.md">https://github.com/AliceO2Group/AliceO2/blob/dev/prodtests/full-system-test/documentation/full-system-test-setup.md</a>.</p>
<h2><a class="el" href="../../db/dd3/structFull.html">Full</a> system test DPL-workflow configuration and scripts</h2>
<p>The full system test workflow scripts consist of 3 shell scripts:</p><ul>
<li><code>dpl-workflow.sh</code> : The main script that runs the dpl-workflow for the reconstruction. It can read the input either internally, or receive it externally by one of the others.</li>
<li><code>raw-reader.sh</code> : Runs the <code>o2-raw-file-reader</code> to read the raw files as external input to <code>dpl-workflow.sh</code>.</li>
<li><code>datadistribution.sh</code> : Run the <code>StfBuilder</code> to read time frame files as external input to <code>dpl-workflow.sh</code>.</li>
</ul>
<p>One can either run the <code>dpl-workflow.sh</code> standalone (with <code>EXTINPUT=0</code>) or in parallel with one of the other scripts in separate shells (with <code>EXTINPUT=1</code>)</p>
<p>There are the additional benchmark script:</p><ul>
<li><code>start_tmux.sh</code> : This starts the full test in the configuration for the EPN with 2 NUMA domains, 512 GB RAM, 8 GPUs. It will run tmux with 3 sessions, running twice the <code>dpl-workflow.sh</code> and once one of the external input scripts (selected via <code>dd</code> and <code>rr</code> command line option).<ul>
<li>Please note that <code>start_tmux.sh</code> overrides several of the environment options (see below) with the defaults for the EPN. The only relevant options for <code>start_tmux.sh</code> should be <code>TFDELAY</code> and <code>GPUMEMSIZE</code>.</li>
<li>Note also that while <code>dpl-workflow.sh</code> is a generic flexible script that can be used for actual operation, <code>start_tmux.sh</code> is a benchmark script to demonstrate how the full workflow is supposed to run on the EPN. It is meant for standalone tests and not to really start the actual processing on the EPN.</li>
</ul>
</li>
<li><code>shm-tool.sh</code> : This starts the SHM management tool in the configuration for start_tmux.sh. This can be used to mimic the fast memory allocation / gpu registration on the EPNs. (See te JIRA ticket for details)</li>
</ul>
<p>In any case, the shared <code>setenv.sh</code> script sets default configuration options.</p>
<p>The <code>dpl-workflow.sh</code> can run both the synchronous and the asynchronous workflow, selected via the <code>SYNCMODE</code> option (see below), but note the following constraints.</p><ul>
<li>By default, it will run the full chain (EPN + FLP parts) such that it can operate as a full standalone benchmark processing simulated raw data.</li>
<li>In order to run only the EPN part (skipping the steps that will run on the FLP), an <code>EPNONLY</code> option will be added later.</li>
</ul>
<p>All settings are configured via environment variables. The default settings (if no env variable is exported) are defined in <code>setenv.sh</code> which is sourced by all other scripts. (Please note that <code>start_tmux.sh</code> overrides a couple of options with EPN defaults). The environment variables are documented here: <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/prodtests/full-system-test/documentation/full-system-test-env-variables.md">https://github.com/AliceO2Group/AliceO2/blob/dev/prodtests/full-system-test/documentation/full-system-test-env-variables.md</a></p>
<h2>Files produced / required by the full system test</h2>
<p>The local files like geometry, material <a class="el" href="../../d1/d4f/classLUT.html">LUT</a> etc. are not anymore needed for reconstruction and calibration workflows, but some QC workflows still need</p><ul>
<li>geometry file o2sim_geometry-aligned.root</li>
<li>old-style (dummy) monolitic GRP file o2sim_grp.root</li>
</ul>
<p>The full system test produces the following output:</p><ul>
<li>QED simulation output in the folder <code>qed</code>.</li>
<li>Normal simulation output (as <code>o2-sim</code>).</li>
<li>Digits from <code>o2-sim-digitizer-workflow</code> and TRD tracklets.</li>
<li>Depending on the options mentioned above, <code>ctf_dictionary.root</code> and <code>ITSdictionary.bin</code> / <code>MFTdictionary.bin</code>.</li>
<li>RAW files in <code>raw/[DETECTOR_NAME]</code></li>
</ul>
<p>By default the <code>dpl-workflow.sh</code> adds sub-workflows with the option <code>--disable-root-output</code>, preventing initialization of writer devices (therefore the intermediate reconstruction files are not produced). This behaviour can be overridden by passing <code>DISABLE_ROOT_OUTPUT=0</code> which will trigger storing all intermediate reconstruction files as well as the creation of the <code>o2_tfidinfo.root</code> file containing timing information of every processed <a class="el" href="../../d5/d14/structTF.html">TF</a> (produced by <code>o2-tfidinfo-writer-workflow</code>). In case intermediate files of only a few workflows are needed, instead of enabling all writers via <code>DISABLE_ROOT_OUTPUT=0</code> one can enable those of particular devices only by passing <code>ENABLE_ROOT_OUTPUT_&lt;workflow_name_with_underscores&gt;=</code>. I.e. to enable storing the output of the <code>o2-its-reco-workflow</code> it is enough to prepend the script by <code>ENABLE_ROOT_OUTPUT_o2_its_reco_workflow=</code>. The <code>o2-tfidinfo-writer-workflow</code> will be invoked if there is at least one workflow with root outputs enabled. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d7/d16/refdoc.html">Documentation pages</a></li>
    <li class="footer">Generated on Fri Oct 31 2025 12:28:23 for Project by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
