<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project: deterministic-mode</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../o2_logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d2/d86/md__2home_2runner_2work_2AliceO2_2AliceO2_2GPU_2documentation_2deterministic-mode.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">deterministic-mode</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The TPC tracking code is not fully deterministic, i.e. running multiple times on the same data set might yield a slightly different number of tracks on the O(per mille) level.</p><ul>
<li>This comes from concurrency, i.e. when tracks are processed in parallel, the output order might change, which might have small effects on the consecutive steps.</li>
<li>Also compile options and optimizations play a row, e.g. using ffast-math or fused-multiply-add might slightly change the rounding of floating point, and in rare cases lead to the acceptance or rejection of a track, and thus a different number of tracks.</li>
</ul>
<p>For debugging, testing, and validation, a deterministic mode is implemented, which should yield 100% reproducible results, on CPU and on GPU and when running multiple times. It uses a combination of</p><ul>
<li>Compile time options, e.g. disabling all optimizations that change floating point rounding.</li>
<li>Run time options, e.g. to use deterministic sorting, and add additional sorting steps after kernels to make the output deterministic, also intermediate outputs.</li>
</ul>
<p>This is steered by 3 options:</p><ul>
<li>The <code>-DGPUCA_DETERMINISTIC_MODE</code> Cmake setting : Compile-time setting.</li>
<li>The <code>--PROCdeterministicGPUReconstruction</code> command line option / <code>GPU_proc.deterministicGPUReconstruction</code> <code>--configKeyValue</code> setting : Run time setting.</li>
<li>The <code>--RTCdeterministic</code> command line option / <code>GPU_proc_rtc.deterministic</code> <code>--configKeyValue</code> setting. (Auto-enabled by the <code>deterministicGPUReconstruction</code> setting.) : Compile-time setting for RTC code.</li>
</ul>
<p>Note that enabling a single setting will not result in fully deterministic behavior! Each setting enables different deterministic aspects! In order to be fully deterministic, all settings must be enabled, where the RTC setting is automatically enabled if not explicitly disabled.</p>
<p><code>GPUCA_DETERMINISTIC_MODE</code> has multiple levels, which are described here: <a href="https://github.com/AliceO2Group/AliceO2/blob/80a80a17f5a1d9cb77743e2a39b15b653fe1a4f9/dependencies/FindO2GPU.cmake#L72">FindO2GPU.cmake</a>.</p><ul>
<li>In order to have fully deterministic GPUReconstruction (i.e. all algorithms that come with the GPUTracking library, like TPC tracking), the level <code>GPUCA_DETERMINISTIC_MODE=GPU</code> is needed.</li>
<li>In order to apply it to all of O2, e.g. for ITS tracking, please use <code>GPUCA_DETERMINISTIC_MODE=WHOLEO2</code></li>
</ul>
<p>Enabling the options is a bit different for O2 and for the standalone benchmark:</p><ul>
<li>For enabling it in the standalone benchmark, please set GPUCA_DETERMINISTIC_MODE=GPU in <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/GPU/GPUTracking/Standalone/cmake/config.cmake">config.cmake</a> and use the command line argument <code>--PROCdeterministicGPUReconstruction 1</code>.</li>
<li>For O2, Either add <code>set(GPUCA_DETERMINISTIC_MODE GPU)</code> to the beginning of the <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/GPU/CMakeLists.txt">GPU CMakeLists.txt</a> or add <code>set(GPUCA_DETERMINISTIC_MODE WHOLEO2)</code> to the beginning of the <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/CMakeLists.txt">Global CMakeLists.txt</a>, and use the <code>configKeyValue</code> <code>GPU_proc.deterministicGPUReconstruction</code>. In order to enable this for the Full-System-Test or with <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/prodtests/full-system-test/dpl-workflow.sh">dpl-workflow.sh</a>, please export <code>CONFIG_EXTRA_PROCESS_o2_gpu_reco_workflow=GPU_proc.deterministicGPUReconstruction=1;</code>.</li>
</ul>
<p>With these settings, if one runs multiple times, the number of clusters and number of tracks should be always fully identical. Note that this yields a significant performance penalty during the processing, therefore the deterministic mode is not compiled in by default, but it must be enabled explicitly and code must be recompiled.</p>
<p>Beyond comparing only the number of clusters and number of tracks, it is also possible to compare intermediate results. To do so, please use the standalone benchmark (either <code>./ca</code> or <code>o2-gpu-standalone-benchmark</code> binary) with the <code>--debug 6</code> option. It will create a dump container all (most) intermediate results in text form, which can be compared. The output files is called <code>CPU.out</code> if using the CPU backend, and <code>GPU.out</code> for the GPU backend. Note that the dump files will be huge and the processing will be slow and consume much more memory than normal with <code>--debug 6 . It has been tested with datasets containing up to 50 Pb-Pb collisions, and might fail for larger data. The dump files (if the deterministic mode is used with both compile- and runtime-activation), the files should be 100% identical and can just be compared with</code>diff`. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Oct 31 2025 12:28:23 for Project by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
