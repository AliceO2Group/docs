<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project: build-standalone</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../o2_logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d4/d7b/md__2home_2runner_2work_2AliceO2_2AliceO2_2GPU_2documentation_2build-standalone.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">build-standalone</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This ticket describes how to build the O2 GPU TPC Standalone benchmark (in its 2 build types), and how to run it.</p>
<p>The purpose of the standalone benchmark is to make the O2 GPU TPC reconstruction code available standalone. It provides</p><ul>
<li>external tests when people do not have / want to build O2, have no access to alien for CCDB, etc.</li>
<li>fast standalone tests without running O2 workflows and overhead from CCTD.</li>
<li>faster build times than rebuilding O2 for development.</li>
</ul>
<h1>Compiling</h1>
<p>The standalone benchmark is build as part of O2, and it can be built standalone.</p>
<p>As part of O2, it is available from the normal O2 build as the executable <code>o2-gpu-standalone-benchmark</code>, GPU support is available for all GPU types supported by the O2 build.</p>
<p>Building it as standalone benchmark requires several dependencies, and provides more control which features to enable / disable. The dependencies can be taken from the system, or we can use alidist to build O2 and take the dependencies from there.</p>
<p>In order to do the latter, please execute: </p><div class="fragment"><div class="line">cd ~/alice # or your alice folder</div>
<div class="line">aliBuild build --defaults o2 O2</div>
<div class="line">source O2/GPU/GPUTracking/Standalone/cmake/prepare.sh</div>
</div><!-- fragment --><p>Then, in order to compile the standalone tool, assuming to have it in ~/standalone and build in ~/standalone/build, please run: </p><div class="fragment"><div class="line">mkdir -p ~/standalone/build</div>
<div class="line">cd ~/standalone/build</div>
<div class="line">cmake -DCMAKE_INSTALL_PREFIX=../ ~/alice/O2/GPU/GPUTracking/Standalone/</div>
<div class="line">nano config.cmake # edit config file to enable / disable dependencies as needed. In case cmake failed, and you disabled the dependency, just rerun the above command.</div>
<div class="line">make install -j32</div>
</div><!-- fragment --><p>You can edit certain build settings in <code>config.cmake</code>. Some of them are identical to the GPU build settings for O2, as described in <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/GPU/documentation/build-O2.md">build-O2.md</a>. And there are plenty of additional settings to enable/disable event display, qa, usage of <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a>, FMT, etc. libraries.</p>
<p>This will create the <code>ca</code> binary in <code>~/standalone</code>, which is basically the same as the <code>o2-gpu-standalone-benchmark</code>, but built outside of O2.</p>
<p>As an exacmple you can also have a look at <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/GPU/GPUTracking/Standalone/cmake/build.sh">build.sh</a>, which is used by the CI.</p>
<h1>Running</h1>
<p>The following command lines will use <code>./ca</code>, in case you use the executable from the O2 build, please replace by <code>o2-gpu-standalone-benchmark</code>.</p>
<p>You can get a list of command line options by <code>./ca --help</code> and <code>./ca --helpall</code>.</p>
<p>In order to run, you need a dataset. See the next section for how to create a dataset. Datasets are stored in <code>~/standalone/events</code>, and are identified by their folder names. The following commands assume a testdataset of name <code>o2-pbpb-100</code>.</p>
<p>To run on that data, the simpled command is <code>./ca -e o2-pbpb-100</code>. This will automatically use a GPU if available, trying all backends, otherwise fall back to CPU. You can force using GPU or CPU with <code>-g</code> and <code>-c</code>. You can select the backend via <code>--gpuType CUDA|HIP|OCL|OCL2</code>, and inside the backend you can select the device number, if multiple devices exist, via <code>--gpuDevice i</code>.</p>
<p>The flag <code>--debug</code> (-2 to 6) enables increasingly extensive debug output, and <code>--debug 6</code> stores full data dumpts of all intermediate steps to files. &gt;= <code>--debug 1</code> has a performance impact since it adds serialization points for debugging. For timing individual kernels, <code>--debug 1</code> prints timing information for all kernels. An example line would .e.g. be </p><div class="fragment"><div class="line">./ca -e o2-pbpb-100 -g --gpuType CUDA --gpuDevice 0 --debug 1</div>
</div><!-- fragment --><p>Some other noteworthy options are <code>--display</code> to run the GPU event display, <code>--qa</code> to run a QA task on MC data, <code>--runs</code> and <code>--runs2</code> to run multiple iterations of the benchmark, <code>--printSettings</code> to print all the settings that were used, <code>--memoryStat</code> to print memory statistics, <code>--sync</code> to run with settings for online reco, <code>--syncAsync</code> to run online reco first, and then offline reco on the produced TPC CTF data, <code>--setO2Settings</code> to use some defaults as they are in O2 not in the standalone version, <code>--PROCdoublePipeline</code> to enable the double-threaded pipeline for best performance (works only with multiple iterations, and not in async mode), and <code>--RTCenable</code> to enable the run time compilation improvements (check also <code>--RTCcacheOutput</code>). With <code>--memSize</code> you can control the amount of GPU memory to use, and with <code>--inputMemory</code> and <code>--outputMemory</code> GPU-registered input/output buffers can be preallocated (as is the SHM memory when running in O2). An example for a benchmark that runs with the same settings as in online data taking would be: </p><div class="fragment"><div class="line">./ca -e o2-pbpb-100 -g --gpuType HIP --sync --setO2Settings --PROCdoublePipeline --RTCenable --runs 10 --memSize 15000000000 --inputMemory 6000000000 --outputMemory 10000000000</div>
</div><!-- fragment --><p>For setting a GPU device, you can use the <code>--gpuDevice</code> option with the GPU index. For ROCm with many GPUs, however, like on the EPNs with 8 GPUs, it is better to set the <code>ROCR_VISIBLE_DEVICES</code> env variable to the GPU you want to use. MAKE SURE TO CHECK IF IT IS ALREADY SET BY SLURM WHEN YOU GET THE NODE!!! IN THAT CASE, USE ONLY THE GPUS ASSIGNED TO YOU BY SLURM!</p>
<p>Finally, also NUMA pinning can play a role. On the EPN, you should use memory and GPUs and CPU cores from the same NUMA domain. For a reaslistic benchmark using GPU 0 on the EPNs, please use: </p><div class="fragment"><div class="line">ROCR_VISIBLE_DEVICES=0 numactl --membind 0 --cpunodebind 0 ./ca -e o2-pbpb-100 --gpuType HIP --memSize 15000000000 --inputMemory 6000000000 --outputMemory 10000000000 --sync --runs 10 --RTCenable --setO2Settings --PROCdoublePipeline</div>
</div><!-- fragment --><p>Note that on the MI50 nodes, we use only &lt;16 GB of memory, since there is a performance regression when using the upper half of the 32 GB. In order to fit in the 16 GB, we have reduced the time frame length to 32 orbits from 2024 onwards.</p>
<h1>Generating a dataset</h1>
<p>The standalone benchmark supports running on Run2 data exported from AliRoot, or to run on Run3 data from O2. This document covers only the O2 case. In <a class="el" href="../../d4/d7c/namespaceo2.html" title="a couple of static helper functions to create timestamp values for CCDB queries or override obsolete ...">o2</a>, <code>o2-tpc-reco-workflow</code> and the <code>o2-gpu-reco-workflow</code> can dump event data with the <code>configKeyValue</code> <code>GPU_global.dump=1;</code>. This will dump the event data to the local folder, all dumped files have a <code>.dump</code> file extension. If there are multiple TFs/events processed, there will be multiple <code>event.i.dump</code> files. In order to create a standalone dataset out of these, just copy all the <code>.dump</code> files to a subfolder in <code>~/standalone/events/[FOLDERNAME]</code>.</p>
<p>Data can be dumped from raw data, or from MC data, e.g. generated by the <a class="el" href="../../db/dd3/structFull.html">Full</a> System Test. In case of MC data, also MC labels are dumped, such that they are used in the <code>./ca --qa</code> mode.</p>
<p>To get a dump from simulated data, please run e.g. the FST simulation as described in <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/prodtests/full-system-test/documentation/full-system-test-setup.md">full-system-test-setup.md</a>. <a class="el" href="../../d2/d88/classA.html">A</a> simple run as </p><div class="fragment"><div class="line">DISABLE_PROCESSING=1 NEvents=5 NEventsQED=100 SHMSIZE=16000000000 $O2_ROOT/prodtests/full_system_test.sh</div>
</div><!-- fragment --><p> should be enough.</p>
<p>Afterwards run the following command to dump the data: </p><div class="fragment"><div class="line">SYNCMODE=1 CONFIG_EXTRA_PROCESS_o2_gpu_reco_workflow=&quot;GPU_global.dump=1;&quot; WORKFLOW_DETECTORS=TPC SHMSIZE=16000000000 $O2_ROOT/prodtests/full-system-test/dpl-workflow.sh</div>
</div><!-- fragment --><p>To dump standalone data from CTF raw data in <code>myctf.root</code>, you can use the same script, e.g.: </p><div class="fragment"><div class="line">CTFINPUT=1 INPUT_FILE_LIST=myctf.root CONFIG_EXTRA_PROCESS_o2_gpu_reco_workflow=&quot;GPU_global.dump=1;&quot; WORKFLOW_DETECTORS=TPC SHMSIZE=16000000000 $O2_ROOT/prodtests/full-system-test/dpl-workflow.sh</div>
</div><!-- fragment --><p>On the EPNs, you can find some reference data sets at <code>/home/drohr/standalone/events</code>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Oct 31 2025 12:28:23 for Project by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
