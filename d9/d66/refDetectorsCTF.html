<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project: CTF Data handling</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../o2_logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d9/d66/refDetectorsCTF.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">CTF Data handling</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>CTF I/O</h1>
<h2>CTF writer workflow</h2>
<p><code>o2-ctf-writer-workflow</code> can be piped in the end of the processing workflow to create CTF data. By default data of every detector flagged in the GRP as being read-out are expected. The list of detectors storing CTF data can be managed using <code>--onlyDet arg (=none)</code> and <code>--skipDet arg (=none)</code> comma-separated lists. Every detector writing CTF data is expected to send an output with entropy-compressed <code>EncodedBlocks</code> flat object.</p>
<p>Example of usage: </p><div class="fragment"><div class="line">o2-its-reco-workflow | o2-itsmft-entropy-encoder-workflow | o2-ctf-writer-workflow --onlyDet ITS</div>
</div><!-- fragment --><p>For the storage optimization reason one can request multiple CTFs stored in the same output file (as entries of the <code>ctf</code> tree): </p><div class="fragment"><div class="line">o2-ctf-writer-workflow --min-file-size &lt;min&gt; --max-file-size &lt;max&gt; ...</div>
</div><!-- fragment --><p> will accumulate CTFs in entries of the same tree/file until its size fits exceeds <code>min</code> and does not exceed <code>max</code> (<code>max</code> check is disabled if <code>max&lt;=min</code>) or EOS received. The <code>--max-file-size</code> limit will be ignored if the very first CTF already exceeds it. Additional option <code>--max-ctf-per-file &lt;N&gt;</code> will forbid writing more than <code>N</code> CTFs to single file (provided <code>N&gt;0</code>) even if the <code>min-file-size</code> is not reached. User may request autosaving of CTFs accumulated in the file after every <code>N</code> TFs processed by passing an option <code>--save-ctf-after &lt;N&gt;</code>.</p>
<p>The output directory (by default: <code>cwd</code>) for CTFs can be set via <code>--output-dir</code> option and must exist. Since in on the EPNs we may store the CTFs on the RAM disk of limited capacity, one can indicate the fall-back storage via <code>--output-dir-alt</code> option. The writer will switch to it if (i) <code>szCheck = max(min-file-size*1.1, max-file-size)</code> is positive and (ii) estimated (accounting for eventual other CTFs files written concurrently) available space on the primary storage is below the <code>szCheck</code>. The available space is estimated as: </p><div class="fragment"><div class="line"> `</div>
<div class="line">current physically available space</div>
<div class="line">-</div>
<div class="line">number still open CTF files from concurrent writers * szCheck</div>
<div class="line">+</div>
<div class="line">the current size of these files</div>
</div><!-- fragment --><p> `</p>
<p>If the option <code>--meta-output-dir &lt;dir&gt;</code> is not <code>/dev/null</code>, the CTF <code>meta-info</code> files will be written to this directory (which must exist!).</p>
<p>By default only CTFs will written. If the upstream entropy compression is performed w/o external dictionaries, then the for every CTF its own dictionary will be generated and stored in the CTF. In this mode one can request creation of dictionary file (or dictionary file per detector if option <code>--dict-per-det</code> is provided) by passing option <code>--output-type dict</code> (in which case only the dictionares will be stored but not the CTFs) or <code>--output-type both</code> (will store both dictionaries and CTF). This is the only valid mode for dictionaries creation (if one requests dictionary creation but the compression was done with external dictionaries, the newly created dictionaries will be empty). In the dictionaries creation mode their data are accumulated over all CTFs procssed. User may request periodic (and incremental) saving of dictionaries after every <code>N</code> TFs processed by passing <code>--save-dict-after &lt;N&gt;</code> option.</p>
<p>Option <code>--ctf-dict-dir &lt;dir&gt;</code> can be provided to indicate the directory where the dictionary will be stored.</p>
<p>The external dictionaries created by the <code>o2-ctf-writer-workflow</code> containes a TTree (one for all participating detectos) and separate dictionaries per detector which can be uploaded to the CCDB. The per-detector dictionaries compatible with CCDB can be also extracted from the common TTree-based dictionary file using the macro <code>O2/Detectors/CTF/utils/CTFdict2CCDBfiles.C</code> (installed to $O2_ROOT/share/macro/CTFdict2CCDBfiles.C) which extracts the dictionary for every detector into separate file containing plain <code>vector&lt;char&gt;</code>. These per-detector files can be directly uploaded to CCDB and accessed via <code>CcdbAPI</code> (the reference of the vector should be provided to corresponding detector CTFCoder::createCoders method to build the run-time dictionary). These files can be also used as per-detector command-line parameters, on the same footing as tree-based dictionaries, e.g. </p><div class="fragment"><div class="line">o2-ctf-reader-workflow --ctf-input input.lst --onlyDet ITS,TPC,TOF --its-entropy-decoder &#39; --ctf-dict ctfdict_ITS_v1.0_1626472046.root&#39; --tpc-entropy-decoder &#39; --ctf-dict ctfdict_TPC_v1.0_1626472048.root&#39; --tof-entropy-decoder  &#39; --ctf-dict ctfdict_TOF_v1.0_1626472048.root&#39;</div>
</div><!-- fragment --><p>See below for the details of <code>--ctf-dict</code> option.</p>
<p>One can pause the writing if available disk space is low using a combination of following options: </p><div class="fragment"><div class="line">--require-free-disk &lt;float&gt;: pause writing operation if available disk space is below this margin in bytes (if &gt; 0) or this fraction of total (if &lt; 0)</div>
</div><!-- fragment --><div class="fragment"><div class="line">--wait-for-free-disk &lt;float seconds&gt;: if paused due to the low disk space, recheck after this time (in s)</div>
</div><!-- fragment --><div class="fragment"><div class="line">--max-wait-for-free-disk &lt;float seconds&gt;: produce fatal if paused due to the low disk space for more than this amount( in s).</div>
</div><!-- fragment --><h2>CTF reader workflow</h2>
<p><code>o2-ctf-reader-workflow</code> should be the 1st workflow in the piped chain of CTF processing. At the moment accepts as an input a comma-separated list of CTF files produced by the <code>o2-ctf-writer-workflow</code>, reads data for all detectors present in it (the list can be narrowed by <code>--onlyDet arg (=none)</code> and <code>--skipDet arg (=none)</code> comma-separated lists), decode them using decoder provided by detector and injects to DPL. In case of multiple entries in the CTF tree, they all will be read in row.</p>
<p>Example of usage: </p><div class="fragment"><div class="line">o2-ctf-reader-workflow --onlyDet ITS --ctf-input o2_ctf_0000000000.root  | o2-its-reco-workflow --trackerCA --clusters-from-upstream --disable-mc</div>
</div><!-- fragment --><p>The option are: </p><div class="fragment"><div class="line">--ctf-input arg (=ccdb)</div>
</div><!-- fragment --><p> inptu data (obligatort): comma-separated list of CTF files and/or files with list of data files and/or directories containing files</p>
<div class="fragment"><div class="line">--onlyDet arg (=all)</div>
</div><!-- fragment --><p> comma-separated list of detectors to read, Overrides skipDet</p>
<div class="fragment"><div class="line">--skipDet arg (=none)</div>
</div><!-- fragment --><p> comma-separated list of detectors to skip</p>
<p>By default an exception will be thrown if detector is requested but missing in the CTF. To enable injection of the empty output in such case one should use option <code>--allow-missing-detectors</code>.</p>
<div class="fragment"><div class="line">--ctf-data-subspec arg (=0)</div>
</div><!-- fragment --><p> allows to alter the <code>subSpecification</code> used to send the CTFDATA from the reader to decoders. Non-0 value must be used in case the data extracted by the CTF-reader should be processed and stored in new CTFs (in order to avoid clash of CTFDATA messages of the reader and writer).</p>
<div class="fragment"><div class="line">--max-tf arg (=-1)</div>
</div><!-- fragment --><p> max CTFs to process (&lt;= 0 : infinite)</p>
<div class="fragment"><div class="line">--max-tf-per-file arg (=-1)</div>
</div><!-- fragment --><p> max TFs to process from every CTF file (&lt;= 0 : infinite)</p>
<div class="fragment"><div class="line">--loop arg (=0)</div>
</div><!-- fragment --><p> loop N times after the 1st pass over the data (infinite for N&lt;0)</p>
<div class="fragment"><div class="line">--delay arg (=0)</div>
</div><!-- fragment --><p> delay in seconds between consecutive CTFs sending (depends also on file fetching speed)</p>
<div class="fragment"><div class="line">--copy-cmd arg (=XrdSecPROTOCOL=sss,unix xrdcp -N root://eosaliceo2.cern.ch/?src ?dst)</div>
</div><!-- fragment --><p> copy command for remote files or <code>no-copy</code> to avoid copying</p>
<div class="fragment"><div class="line">--ctf-file-regex arg (=.+o2_ctf_run.+\.root$)</div>
</div><!-- fragment --><p> regex string to identify CTF files: optional to filter data files (if the input contains directories, it will be used to avoid picking non-CTF files)</p>
<div class="fragment"><div class="line">--remote-regex arg (=^/eos/aliceo2/.+)</div>
</div><!-- fragment --><p> regex string to identify remote files</p>
<div class="fragment"><div class="line">--max-cached-files arg (=3)</div>
</div><!-- fragment --><p> max CTF files queued (copied for remote source).</p>
<p>There is a possibility to read remote root files directly, w/o caching them locally. For that one should: 1) provide the full URL the remote files, e.g. if the files are supposed to be accessed by <code>xrootd</code> (the <code>XrdSecPROTOCOL</code> and <code>XrdSecSSSKT</code> env. variables should be set up in advance), use <code>root://eosaliceo2.cern.ch//eos/aliceo2/ls2data/...root</code> (use <code>xrdfs root://eosaliceo2.cern.ch ls -u &lt;path&gt;</code> to list full URL). 2) provide proper regex to define remote files, e.g. for the example above: <code>--remote-regex "^root://.+/eos/aliceo2/.+"</code>. 3) pass an option <code>--copy-cmd no-copy</code>.</p>
<h2>Selective <a class="el" href="../../d5/d14/structTF.html">TF</a> reading</h2>
<div class="fragment"><div class="line">--select-ctf-ids &lt;id&#39;s of CTFs to select&gt;</div>
</div><!-- fragment --><p> This is a <code>ctf-reader</code> device local option allowing selective reading of particular CTFs. It is useful when dealing with CTF files containing multiple TFs. The comma-separated list of increasing CTFs indices must be provided in the format parsed by the <code>RangeTokenizer&lt;int&gt;</code>, e.g. <code>1,4-6,...</code>. Note that the index corresponds not to the entry of the <a class="el" href="../../d5/d14/structTF.html">TF</a> in the CTF tree but to the reader own counter incremented throught all input files (e.g. if the 10 CTF files with 20 TFs each are provided for the input and the selection of TFs <code>0,2,22,66</code> is provided, the reader will inject to the DPL the TFs at entries 0 and 2 from the 1st CTF file, entry 5 of the second file, entry 6 of the 3d and will finish the job.</p>
<div class="fragment"><div class="line">--ir-frames-files &lt;root_file_with_IRFrames_to_select&gt; --skip-skimmed-out-tf</div>
</div><!-- fragment --><p> This option (used for skimming) allow to push to DPL only those TFs which overlap with selected BC-ranges provided via input root file (for various formats see <code><a class="el" href="../../d0/d46/classo2_1_1utils_1_1IRFrameSelector.html#a50bb441aa4a80bad6a9e067ae3c7bfbc">o2::utils::IRFrameSelector::loadIRFrames</a></code> method).</p>
<div class="fragment"><div class="line">--ir-frames-files &lt;root_file_with_IRFrames_to_select&gt;</div>
</div><!-- fragment --><p> This option allows to push to DPL only those TFs which overlap with the <code>&lt;runnumber&gt; &lt;range-min&gt; &lt;range-max&gt;</code> (separators can be any whitespace, comma or semicolon) records provided via text file (assuming that there are some entries for a given run, otherwise the option is ignored). Multiple ranges per run and multiple runs can be mentioned in a single input file. The range limits can be indicated either as a UNIX timestamp in <code>ms</code> or as an orbit number (in the fill the run belongs to).</p>
<p>In case an option </p><div class="fragment"><div class="line">--invert-irframe-selection</div>
</div><!-- fragment --><p> is provided, the selections above are inverted: TFs matching some of the provided ranges will be discarded, while the rest will be pushed to the DPL</p>
<p>At the end of the processing the <code>ctf-writer</code> will create a local file <code>ctf_read_ntf.txt</code> containing only the number of TFs pushed to the DPL. In case no <a class="el" href="../../d5/d14/structTF.html">TF</a> passed the selections above, this file will contain 0.</p>
<h2>Support for externally provided encoding dictionaries</h2>
<p>In absence of the external dictionary the encoding with generate for every <a class="el" href="../../d5/d14/structTF.html">TF</a> and store in the CTF the dictionary information necessary to decode the CTF. Since the time needed for the creation of dictionary and encoder/decoder may exceed encoding/decoding time, there is a possibility to create in a separate pass a dictionary stored in the CTF-like object and use it for further encoding/decoding.</p>
<p>The option <code>--ctf-dict &lt;OPT&gt;</code> steers in all detectors entropy encoders the fething of the entropy dictionary. The choices for OPT are: 1) <code>"ccdb"</code> (or empty string): leads to using CCDB objec fetching by the DPL CCDB service (default)</p>
<p>2) <code>&lt;filename&gt;</code>: use the dictionary from provided file (either tree-based format or flat one in CCDB format)</p>
<p>3) <code>"none"</code>: do not use external dictionary, instead per-TF dictionaries will be stored in the CTF</p>
<p>To create a dictionary run usual CTF creation chain but with extra option, e.g.: </p><div class="fragment"><div class="line">o2-its-reco-workflow | o2-itsmft-entropy-encoding-workflow --ctf-dict none | o2-ctf-writer-workflow --output-type dict --onlyDet ITS</div>
</div><!-- fragment --><p> This will create a file <code>ctf_dictionary_&lt;date&gt;_&lt;NTF_used&gt;.root</code> (linked to <code>ctf_dictionary.root</code>) containing dictionary data in a TTree format for all detectors processed by the <code>o2-ctf-writer-workflow</code>. Additionally, for every participation detector a <code>ctf_dictionary_&lt;DET&gt;_v&lt;version&gt;_&lt;data&gt;_&lt;NTF_used&gt;.root</code> file will be produced, with the dictionary in the flat format. These files can be directly uploaded to the CCDB. By default the dictionary file is written on the exit from the workflow, in <code>CTFWriterSpec::endOfStream()</code> which is currently not called if the workflow is stopped by <code>ctrl-C</code>. Periodic incremental saving of so-far accumulated dictionary data during processing can be triggered by providing an option <code>--save-dict-after &lt;N&gt;</code>.</p>
<p>When decoding CTF containing dictionary data (i.e. encoded w/o external dictionaries), externally provided dictionaries will be ignored.</p>
<p>To apply <a class="el" href="../../d5/d14/structTF.html">TF</a> rate limiting (make sure that no more than N TFs are in processing) provide <code>--timeframes-rate-limit &lt;N&gt; --timeframes-rate-limit-ipcid &lt;IPCID&gt;</code> too all workflows (e.g. via ARGS_ALL). The IPCID is the NUMA domain ID (usually 0 on non-EPN workflow). Additionally, one may throttle on the free SHM by providing an option to the reader <code>--timeframes-shm-limit &lt;shm-size&gt;</code>.</p>
<p>Note that by default the reader reads into the memory the CTF data and prepares all output messages but injects them only once the rate-limiter allows that. With the option <code>--limit-tf-before-reading</code> set also the preparation of the data to inject will be conditioned by the green light from the rate-limiter.</p>
<h2>Modifying ITS/MFT CTF output</h2>
<p>For the ITS and MFT entropy decoding one can request either to decompose clusters to digits and send them instead of clusters (via <code>o2-ctf-reader-workflow</code> global options <code>--its-digits</code> and <code>--mft-digits</code> respectively) or to apply the noise mask to decoded clusters (or decoded digits). If the masking (e.g. via option <code>--its-entropy-decoder " --mask-noise "</code>) is requested, user should provide to the entropy decoder the noise mask file (eventually will be loaded from CCDB) and cluster patterns decoding dictionary (if the clusters were encoded with patterns IDs). For example, </p><div class="fragment"><div class="line">o2-ctf-reader-workflow --ctf-input &lt;ctfFiles&gt; --onlyDet ITS,MFT --its-entropy-decoder &#39; --mask-noise&#39; | ...</div>
</div><!-- fragment --><p> will decode ITS and MFT data, decompose on the fly ITS clusters to digits, mask the noisy pixels with the provided masks, recluster remaining ITS digits and send the new clusters out, together with unchanged MFT clusters. </p><div class="fragment"><div class="line">o2-ctf-reader-workflow --ctf-input &lt;ctfFiles&gt; --onlyDet ITS,MFT --mft-digits --mft-entropy-decoder &#39; --mask-noise&#39; | ...</div>
</div><!-- fragment --><p> will send decompose clusters to digits and send ben out after masking the noise for the MFT, while ITS clusters will be sent as decoded. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d0/d2f/refDetectors.html">Module &#39;Detectors&#39;</a></li>
    <li class="footer">Generated on Sat Feb 21 2026 17:59:16 for Project by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
