<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project: IDC Calibration</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../o2_logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d0/d83/refTPCcalibrationIDC.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">IDC Calibration</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>IDCs</h1>
<p>Brief instruction on how to run the <code>IDC</code> workflow on the FLPs and the aggregator node and how to run it on a local machine using simulated digits as input.</p>
<h4>Definition of <code>IDC</code>s:</h4>
<p><code>IDC</code>: $ I(r,\phi,t) $ \ <code>IDC0</code>: $I_0(r,\phi) = \langle I(r,\phi,t) \rangle _{t=1000\text{ TFs}}$ \ <code>IDC1</code>: $I_1(t) = \langle I(r,\phi,t) / I_0(r,\phi) \rangle _{r,\phi}$ \ <code>IDCDelta</code>: $ \Delta I(r,\phi,t) = I(r,\phi,t) / \left[ I_0(r,\phi) \cdot I_1(t) \right] $</p>
<h1>IDC Workflow (FLPs and aggregator)</h1>
<h2>FLPs</h2>
<p>The <code>IDC</code>s are integrated on the CRUs and converted to a <code>std::vector&lt;float&gt;</code> using the <code>o2-tpc-idc-to-vector</code> workflow. The <code>IDC1</code> are used for the fourier transform and the resulting coefficients as an input for the space-charge correction. For the synchronous reconstruction the <code>IDC1</code> are calculated on the FLPs using the <code>o2-tpc-idc-flp</code> workflow and send to the EPNs for the FFT. The FFT is performed on the EPNs by the <code>o2-tpc-idc-ft-epn</code> workflow. Additionally the <code>IDC</code>s are send to an aggregator for performing the factorization of the <code>IDC</code>s for a given calibration interval and afterwards performing the FFT. The factorized <code>IDC</code>s (<code>IDC0</code>, <code>IDC1</code>, <code>IDCDelta</code>) and the fourier coefficients can then be stored in the CCDB.</p>
<h4><code>IDC1</code> on FLPs</h4>
<p>Parallelisation can be archieved by splitting the CRUs on an FLP to an own device using <code>--lanes</code> or by using time lanes <code>--time-lanes</code>:</p>
<div class="fragment"><div class="line">o2-tpc-idc-flp                       \ # calculation of `IDC1`</div>
<div class="line">--lanes 2                            \ # crus of the FLP will be split to two parallel processes</div>
<div class="line">--time-lanes 1                       \ # number of time lanes</div>
<div class="line">--disableIDC0CCDB true               \ # do not load the `IDC0` from the CCDB which will be used for normalization of the `IDC`s</div>
<div class="line">--crus ${crus}                       \ # expected CRUs</div>
<div class="line">--enable-synchronous-processing true \ # enable `IDC1` calculation</div>
</div><!-- fragment --><h4>Output proxy</h4>
<p>Sending the <code>IDC</code>s from the FLPs to the aggregator node:</p>
<div class="fragment"><div class="line">loc=&quot;&#39;downstream:TPC/IDCGROUPA;downstream:TPC/IDCGROUPC&#39;&quot; # output address for `IDC`s</div>
<div class="line"> </div>
<div class="line">o2-dpl-output-proxy                                                                                        \</div>
<div class="line">--channel-config &quot;name=downstream,method=connect,address=tcp://localhost:30453,type=push,transport=zeromq&quot; \</div>
<div class="line">--dataspec ${loc} -b</div>
</div><!-- fragment --><h2>Aggregator</h2>
<p>On the aggregator node the <code>IDC</code>s from the FLPs are received by an input proxy and aggregated until data from all defined CRUs have been received. After the <code>IDC</code>s for a given number of TFs are received, the factorization of the <code>IDC</code>s, the averaging/grouping of the factorized <code>IDCDelta</code> and the FFT of the factorized <code>IDC1</code> is performed. The factorized <code>IDC</code>s, the grouping parameters and the fourier coefficients can be stored in the CCDB using the <code>o2-calibration-ccdb-populator-workflow</code> workflow.</p>
<h4>Set global parameters for the workflow:</h4>
<div class="fragment"><div class="line">crus=&quot;0-359&quot;                # expect data from all CRUs from FLPs</div>
<div class="line">lanes=2                     # number of parallel devices for the factorization (min. 2 devices should be used)</div>
<div class="line">nTFs=1000                   # number of TFs which will be used for the factorization and the Fourier transform</div>
<div class="line">url=&quot;http://localhost:8080&quot; # CCDB URI: for local CCDB or use &quot;http://ccdb-test.cern.ch:8080&quot;</div>
</div><!-- fragment --><h4>Input proxy</h4>
<p>Receiving the <code>IDC</code>s from the FLPs:</p>
<div class="fragment"><div class="line"># input adresses for `IDC`s</div>
<div class="line">loc=&quot;A:TPC/IDCGROUPA;A:TPC/IDCGROUPC&quot;</div>
<div class="line"> </div>
<div class="line"># running the input proxy</div>
<div class="line">o2-dpl-raw-proxy  \</div>
<div class="line">--dataspec ${loc} \</div>
<div class="line">--channel-config &quot;name=readout-proxy,type=pull,method=bind,address=tcp://localhost:30453,rateLogging=1,transport=zeromq&quot;</div>
</div><!-- fragment --><h4>Distribute received <code>IDC</code>s from proxy</h4>
<p>Receiving the <code>IDC</code>s from the proxy and distribute them to the <code>o2-tpc-idc-factorize</code> workflow for factorization according to the number of specified lanes (also perform checks if some data is dropped. In case data is droped, empty dummy data is send):</p>
<div class="fragment"><div class="line">o2-tpc-idc-distribute  \</div>
<div class="line">--crus=${crus}         \ # expected CRUs</div>
<div class="line">--timeframes ${nTFs}   \ # number of TFs which will be send to one factorization device</div>
<div class="line">--output-lanes ${lanes}  # number of output lanes for parallelisation of factorisation</div>
</div><!-- fragment --><h4>Factorization of <code>IDC</code>s</h4>
<p>Perform the factorization of the <code>IDC</code>s i.e. convert the <code>IDC</code>s to <code>IDC0</code>, <code>IDC1</code>, <code>IDCDelta</code> and perform the averaging/grouping and compression of <code>IDCDelta</code>. The grouping parameters can be set with e.g. <code>--groupPads "..." --groupRows "..."</code>. <a class="el" href="../../d2/d88/classA.html">A</a> dedicated grouping at the edge of the sectors can be set via e.g. &lsquo;--configKeyValues 'TPCIDCGroupParam.groupPadsSectorEdges=32211&rsquo;`.</p>
<div class="fragment"><div class="line">o2-tpc-idc-factorize                \</div>
<div class="line">--crus=${crus}                      \ # expected CRUs</div>
<div class="line">--timeframes ${nTFs}                \ # number of TFs which were send from o2-tpc-idc-distribute</div>
<div class="line">--input-lanes ${lanes}              \ # number of lanes which were defined in o2-tpc-idc-distribute</div>
<div class="line">--groupPads &quot;5,6,7,8,4,5,6,8,10,13&quot; \ # number of pads in pad direction which are grouped</div>
<div class="line">--groupRows &quot;2,2,2,3,3,3,2,2,2,2&quot;   \ # number of pads in row direction which are grouped</div>
<div class="line">--nthreads-grouping 8               \ # number of threads used for the grouping</div>
<div class="line">--nthreads-IDC-factorization 8      \ # number of threads used for the factorization</div>
<div class="line">--enablePadStatusMap true           \ # perform outlier filtering using the `IDC0`</div>
<div class="line">--enable-CCDB-output true           \ # enable creation/sending of CCDB output + grouping of `IDCDelta`</div>
<div class="line">--sendOutputFFT true                \ # send the output to the `o2-tpc-idc-ft-aggregator`</div>
</div><!-- fragment --><h4>FFT</h4>
<p>Receive <code>IDC1</code> from the <code>o2-tpc-idc-factorize</code> and perform the FFT of <code>IDC1</code>:</p>
<div class="fragment"><div class="line">o2-tpc-idc-ft-aggregator \</div>
<div class="line">--rangeIDC 200           \ # number of `IDC1` used during the FFT per TF</div>
<div class="line">--nFourierCoeff 40       \ # number of fourier coefficients per TF which will be stored in the CCDB</div>
<div class="line">--inputLanes ${lanes}    \ # number of lanes which were defined in `o2-tpc-idc-distribute`</div>
<div class="line">--nthreads 8             \ # number of threads used for the FFT</div>
</div><!-- fragment --><h3><a class="el" href="../../d1/d4a/structSummary.html">Summary</a></h3>
<p>All the steps which have to be called (on a local machine):</p>
<h4>Send raw data</h4>
<div class="fragment"><div class="line"># FLPs</div>
<div class="line">crus=&quot;0-359&quot;</div>
<div class="line">loc=&quot;&#39;downstream:TPC/IDCGROUPC;downstream:TPC/IDCGROUPA&#39;&quot;</div>
<div class="line"> </div>
<div class="line">pathToRawData=&quot;/../path/to/data/&quot;</div>
<div class="line"> </div>
<div class="line">o2-raw-tf-reader-workflow         \</div>
<div class="line">--input-data ${pathToRawData}     \</div>
<div class="line">--shm-segment-size $((8&lt;&lt;30))     \</div>
<div class="line">| o2-tpc-idc-to-vector            \</div>
<div class="line">--crus ${crus}                    \</div>
<div class="line">| o2-tpc-idc-flp                  \</div>
<div class="line">--crus ${crus}                    \</div>
<div class="line">--disableIDC0CCDB true            \</div>
<div class="line">--lanes 1                         \</div>
<div class="line">| o2-dpl-output-proxy --channel-config &quot;name=downstream,method=connect,address=tcp://localhost:30453,type=push,transport=zeromq&quot; --dataspec ${loc} -b</div>
</div><!-- fragment --><h4>Receive raw data</h4>
<div class="fragment"><div class="line"># define global parameters for the work flow</div>
<div class="line">crus=&quot;0-359&quot; # expect data from all CRUs from FLPs</div>
<div class="line">lanes=2      # number of parallel devices for the factorization (min. 2 devices should be used)</div>
<div class="line">nTFs=1000    # number of TFs which will be used for the factorization and the Fourier transform</div>
<div class="line"> </div>
<div class="line"># input adresses for `IDC`s</div>
<div class="line">loc=&quot;A:TPC/IDCGROUPA;A:TPC/IDCGROUPC&quot;</div>
<div class="line"> </div>
<div class="line"># shm size</div>
<div class="line">ARGS_ALL=&quot;--shm-segment-size 50000000000&quot;</div>
<div class="line"> </div>
<div class="line"># proxy settings</div>
<div class="line">configProxy=&quot;name=readout-proxy,type=pull,method=bind,address=tcp://localhost:30453,rateLogging=1,transport=zeromq&quot;</div>
<div class="line"> </div>
<div class="line">o2-dpl-raw-proxy ${ARGS_ALL}        \</div>
<div class="line">--dataspec ${loc}                   \</div>
<div class="line">--channel-config &quot;${configProxy}&quot;   \</div>
<div class="line">| o2-tpc-idc-distribute ${ARGS_ALL} \</div>
<div class="line">--crus=${crus}                      \</div>
<div class="line">--timeframes ${nTFs}                \</div>
<div class="line">--output-lanes ${lanes}             \</div>
<div class="line">| o2-tpc-idc-factorize ${ARGS_ALL}  \</div>
<div class="line">--crus=${crus}                      \</div>
<div class="line">--timeframes ${nTFs}                \</div>
<div class="line">--input-lanes ${lanes}              \</div>
<div class="line">--nthreads-grouping 8               \</div>
<div class="line">--nthreads-IDC-factorization 8      \</div>
<div class="line">--nTFsMessage 250                   \</div>
<div class="line">--enablePadStatusMap true           \</div>
<div class="line">--enable-CCDB-output true           \</div>
<div class="line">--sendOutputFFT true                \</div>
<div class="line">--configKeyValues &#39;TPCIDCGroupParam.groupPadsSectorEdges=32211&#39; \</div>
<div class="line">| o2-tpc-idc-ft-aggregator ${ARGS_ALL} \</div>
<div class="line">--rangeIDC 200                         \</div>
<div class="line">--nFourierCoeff 40                     \</div>
<div class="line">--timeframes ${nTFs}                   \</div>
<div class="line">--nthreads 8                           \</div>
<div class="line">| o2-calibration-ccdb-populator-workflow --ccdb-path ccdb-test.cern.ch:8080 \</div>
<div class="line">-b</div>
</div><!-- fragment --><h1>IDC Workflow using simulated digits</h1>
<p>One can also use simulated raw digits as input or use the <code>o2-tpc-idc-test-ft</code> workflow to generate random <code>IDC</code>s or load <code>IDC</code>s from an input file (and perform some randomization on it).</p>
<h3>Simulate the input</h3>
<p>Run a <code>o2-sim</code> simulation, create the digits and the raw digits (e.g.):</p>
<div class="fragment"><div class="line"># running o2-sim</div>
<div class="line">o2-sim -g pythia8pp -n 600 -m TPC [ PIPE ITS ]</div>
<div class="line"> </div>
<div class="line"># producing tpc digits for 5MHz interaction rate</div>
<div class="line">o2-sim-digitizer-workflow -b -q â€”onlyDet TPC --disable-mc --TPCuseCCDB --shm-segment-size $((8&lt;&lt;35)) --interactionRate 5000000</div>
<div class="line"> </div>
<div class="line"># to create raw data</div>
<div class="line">o2-tpc-digits-to-rawzs -i tpcdigits.root -o raw/TPC</div>
</div><!-- fragment --><p>Start the following workflows to perform the factorization of the <code>IDC</code>s, the grouping of the <code>IDCDelta</code>, FFT on aggregator and EPN and writing the output to the CCDB and to local files:</p>
<div class="fragment"><div class="line">shm=&quot;50000000000&quot;</div>
<div class="line">nTFs=1  # consider only the first TF</div>
<div class="line">nLoop=1 # number of loops over the data</div>
<div class="line"> </div>
<div class="line">o2-raw-file-reader-workflow --detect-tf0 --shm-segment-size ${shm} --input-conf raw/TPC/tpcraw.cfg --loop ${nLoop} --max-tf 0 \</div>
<div class="line">| o2-tpc-reco-workflow --input-type zsraw --output-type digits,disable-writer \</div>
<div class="line">| o2-tpc-idc-integrate              \</div>
<div class="line">| o2-tpc-idc-flp                    \</div>
<div class="line">--disableIDC0CCDB true              \</div>
<div class="line">--lanes 1                           \</div>
<div class="line">--enable-synchronous-processing true \</div>
<div class="line">| o2-tpc-idc-distribute             \</div>
<div class="line">--timeframes ${nTFs}                \</div>
<div class="line">--condition-tf-per-query -1         \</div>
<div class="line">--send-precise-timestamp true       \</div>
<div class="line">| o2-tpc-idc-factorize              \</div>
<div class="line">--timeframes ${nTFs}                \</div>
<div class="line">--nthreads-grouping 4               \</div>
<div class="line">--configKeyValues &#39;TPCIDCGroupParam.groupPadsSectorEdges=32211&#39; \</div>
<div class="line">--dump-IDCs true                    \</div>
<div class="line">--dump-IDCDelta                     \</div>
<div class="line">--enable-CCDB-output true           \</div>
<div class="line">--sendOutputFFT true                \</div>
<div class="line">| o2-tpc-idc-ft-aggregator          \</div>
<div class="line">--rangeIDC 200                      \</div>
<div class="line">--nFourierCoeff 40                  \</div>
<div class="line">--dump-coefficients-agg true        \</div>
<div class="line">| o2-tpc-idc-ft-epn                 \</div>
<div class="line">--rangeIDC 200                      \</div>
<div class="line">--nFourierCoeff 40                  \</div>
<div class="line">--dump-coefficients-epn true        \</div>
<div class="line">-b</div>
</div><!-- fragment --><h1>IDC generator Workflow</h1>
<p>One can also generate <code>IDC</code>s as input for the <code>o2-tpc-idc-flp</code> workflow using the <code>o2-tpc-idc-test-ft</code> workflow. The <code>IDC</code>s can be generated randomly from a gaussian distribution or one can load <code>IDC</code>s from a <code>IDCGroup.root</code> file (<code>--load-from-file true</code>) created from a simulation etc. which were written to file with the <code>o2-tpc-idc-flp</code> workflow (<code>o2-tpc-idc-flp --dump-idcs-flp true</code>).</p>
<div class="fragment"><div class="line"> bash</div>
<div class="line">nTFs=1000 # number of TFs to generate</div>
<div class="line"> </div>
<div class="line">o2-tpc-idc-test-ft                  \</div>
<div class="line">--dropTFsRandom 20                  \ # randomly drop every n-Th TF</div>
<div class="line">--delay true                        \</div>
<div class="line">--load-from-file true               \</div>
<div class="line">--only-idc-gen true                 \</div>
<div class="line">--timeframes ${nTFs}                \</div>
<div class="line">| o2-tpc-idc-flp                    \</div>
<div class="line">--disableIDC0CCDB true              \</div>
<div class="line">--lanes 1                           \</div>
<div class="line">--enable-synchronous-processing true \</div>
<div class="line">--severity warning                  \</div>
<div class="line">| o2-tpc-idc-distribute             \</div>
<div class="line">--timeframes ${nTFs}                \</div>
<div class="line">--condition-tf-per-query -1         \</div>
<div class="line">--send-precise-timestamp true       \</div>
<div class="line">--severity warning                  \</div>
<div class="line">| o2-tpc-idc-factorize              \</div>
<div class="line">--timeframes ${nTFs}                \</div>
<div class="line">--nthreads-grouping 1               \</div>
<div class="line">--configKeyValues &#39;TPCIDCGroupParam.groupPadsSectorEdges=32211&#39; \</div>
<div class="line">--enable-CCDB-output true           \</div>
<div class="line">--sendOutputFFT true                \</div>
<div class="line">--nTFsMessage 250                   \</div>
<div class="line">| o2-tpc-idc-ft-aggregator          \</div>
<div class="line">--rangeIDC 200                      \</div>
<div class="line">--nFourierCoeff 40                  \</div>
<div class="line">| o2-tpc-idc-ft-epn                 \</div>
<div class="line">--rangeIDC 200                      \</div>
<div class="line">--nFourierCoeff 40                  \</div>
<div class="line">--severity warning                  \</div>
<div class="line">-b</div>
</div><!-- fragment --> <h2>Unit test for FFT</h2>
<p>To test and compare the fourier coefficients which are calculated on the aggregator for a given integration interval and on the EPNs per <a class="el" href="../../d5/d14/structTF.html">TF</a> the <code>o2-tpc-idc-test-ft</code> can be used. In a first iteration the <code>IDC0</code> are calculated and dumped to a file. In a next iteration the dumped <code>IDC0</code> are used in the <code>o2-tpc-idc-flp</code> workflow for normalization of the <code>IDC</code>s and calculation of <code>IDC1</code>. The <code>IDC1</code> are then used in the <code>o2-tpc-idc-ft-epn</code> workflow to perform the FFT. The <code>IDC</code>s from the <code>o2-tpc-idc-flp</code> workflow are send to the <code>o2-tpc-idc-factorize</code> where the factorization and calculation of <code>IDC1</code> will be performed and send to <code>o2-tpc-idc-ft-aggregator</code> which performs the FFT. The fourier coefficients from the <code>o2-tpc-idc-ft-epn</code> are at the end compared with the fourier coefficients from the <code>o2-tpc-idc-ft-aggregator</code> workflow.</p>
<div class="fragment"><div class="line">crus=&quot;0-179&quot; # use CRUs from only one TPC side</div>
<div class="line">o2-tpc-idc-test-ft --timeframes 200 --delay true --iter 0 --crus $crus --dump-IDC0</div>
<div class="line">o2-tpc-idc-test-ft --timeframes 200 --delay true --iter 1 --crus $crus</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d0/d2f/refDetectors.html">Module &#39;Detectors&#39;</a></li><li class="navelem"><a class="el" href="../../d5/d4d/refDetectorsTPC.html">TPC</a></li><li class="navelem"><a class="el" href="../../d7/d91/refTPCcalibration.html">TPC Calibration</a></li>
    <li class="footer">Generated on Sat Feb 21 2026 17:59:16 for Project by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
